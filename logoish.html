<!DOCTYPE HTML>
<html>
<!--
 This file is part of "Logoish".

    Logoish is free software: you can redistribute it and/or modify
    it under the terms of the GNU Lesser General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Logoish is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU Lesser General Public License
    along with logoish.  If not, see <http://www.gnu.org/licenses/>.
-->


    <head>
        <style>
            .command_history{
                font-style:italic;
                color:blue;
                cursor:copy;
                }
            .command_history:before{
                content:'>';
                color:#999;
            }
            #log{
                height:7em; 
                margin: 0.3em; 
                padding: 1em; 
                overflow: auto; 
                font-size: 0.8em; 
                line-height: 1.1em; 
                border: 1px solid lightgray; 
                border-radius: 0.5em;
            }
            #c{
                width:512px; 
                height:512px;
                margin:5px; 
                border:1px solid black;
                box-shadow: 0px 0px 4px 4px gray;
                display: inline-block;
            }
            #playtable{
                display: inline-block; 
                margin: .2em;
                margin-top: 0;
            }
            #command{
                box-shadow: 0px 0px 6px -1px; 
                height:480px;
                width:500px;
                border: 1px double darkgray; 
                border-radius: 0.4em; 
                display:inline-block; 
                vertical-align:bottom;
            }

        </style>
    </head>
    <body style="margin:2px; padding:2px;">
        <div id="log">Log: </div>
        <div id=playtable style="">
            <canvas height="512" width="512" id="c" ></canvas>
            <div style="display:inline-block">
                <input onclick="executecommand();" value="Run" type="button"><br>
                <textarea tabindex="1" name="command" id="command" placeholder="Type command(s) here. Press Control+Enter to Run. Type help for a list of commands"></textarea>
            </div>
        </div>
    <script>
        Array.prototype.split=function(seperator){
                                data=this.slice();
                                var i=this.indexOf(seperator);
                                if (i==-1) {return [data]} ; 
                                ret=[]; 
                                while (i != -1){
                                    ret.push(data.slice(0,i));
                                    data.splice(0,i+1);
                                    i=data.indexOf(seperator);
                                } 
                                ret.push(data);
                                return ret 
                              };
        function getNum(s){
            if (isNaN(s)) 
                return 0;
            else 
                return (parseFloat(s));
        }
        function logIt(message){
            log.innerHTML+='<br>'+message;
            log.scrollTop = log.scrollTopMax;
            log.scrollTop = log.scrollHeight;
        }

        function debug(message){
            if (debug_mode) logIt(message);
        }

        function extractblock_multi(params,startstring,endstring){
              var i, count,endrange_i;
              for (i = 0, count=1; (0 != count) && (i < params.length) ; i++){
                  if (startstring == params[i]) count++; 
                  if (endstring == params[i]) count--; 
              }
              if (count!=0){ throw ("NO matching "+endstring)};  
              var extracted=params.slice(0,i - 1);
              params.splice(0,i);
              return extracted;
        }

        function extractblock_single(params,startstring,endstring){
              var endrange_i = params.indexOf(endstring);
              if (endrange_i==-1){ throw ("NO matching "+endstring) }   
              var extracted=params.slice(0,endrange_i);
              params.splice(0,endrange_i+1);
              return extracted;
        }

        var c=document.getElementById('c');
        var log=document.getElementById('log');
        var i=document.getElementById('command');

        var curcommand=-1;
        var skipwords=['' , ';' , ',' , '[' , ']' , '(' , ')' , '{' , '}' ];
        var key_offset={'Down':1,'Up':-1};
        i.onkeypress=function(e){
            if (e.ctrlKey==true && e.keyCode==13){
                executecommand();
            }
            if (e.ctrlKey==true && (e.keyCode==38 || e.key=="Up" || e.keyCode==40 || e.key=='Down') && (i.value=="" || curcommand != -1)){
                if (curcommand==-1) curcommand=0;
                curcommand=((command_history.length+curcommand+key_offset[e.key])%(command_history.length));
                var s=command_history[curcommand];
                if (s!=undefined)
                    i.value=s;
            } else {
                curcommand=-1;
            }
        };

        var last_run_command='';
        var command_history=[];
        var vars={};
        var lists={};
        var userfunctions={}
        var generated_code={};

        var execlvl=0;
        var debug_mode=false;
        var saveLast=true;
        c.width=512;c.height=512;
        var cx=c.getContext('2d');
        var command, params;
        var pen={x:0,y:0,angle:0,down:false,color:'black',width:1};
        var piBy180=Math.PI/180;
        var saveLast=true;


        function htmlescape(thestring){
            return escape(thestring).replace(/%(..)/g,"&#x$1;");
        }

        function executecommand(){
            var thecommand = i.value;
            command_history.push(thecommand);
            logIt('<a onclick="if (i.value=='+"''" +') {i.value=command_history[' + (command_history.length - 1) + '];}" class=command_history style="">'+ htmlescape(thecommand) +'</span>' );
            execcommand(thecommand);
            if (saveLast) last_run_command=thecommand;
        }

        function execcommand(cmdline,save){
            if (save == undefined) 
                saveLast = true; 
            else 
                saveLast = save;
            params = cmdline.split(/\s+/);
            params = params.filter(function(x){ return (skipwords.indexOf(x) == -1) });
            execit(params);
        }

        function evaluate (params){
            var curparam=params.shift();
            if (!isNaN(curparam)) {
                return curparam;
            }
            var varname='vars:'+curparam;
            if (vars.hasOwnProperty(varname)) {
                return vars[varname];
            }             
            var varname='func:'+curparam;
            if (functions.hasOwnProperty(varname)) {
                return functions[varname].run(params);
            }
            return curparam;
        }


        var functions={
            'func:sin':{run:function(params) {
                    return (Math.sin(piBy180 * parseFloat(evaluate(params))));
                },
                help:'Trignometric sine function',
                shorthelp:'Trignometric sine function',
                params:{
                    angle:{
                        help:'The angle to get sine for. Accepts degrees',
                        type:'angle'
                    }
                },
                returns:{
                    help:'The sine of the angle',
                    type:'float'
                }
            },
            'func:cos':{run:function(params) { 
                    return (Math.cos(piBy180 * parseFloat(evaluate(params))));
                },
                help:'Trignometric cosine function',
                shorthelp:'Trignometric cosine function',
                params:{
                    angle:{
                        help:'The angle to get cosine for. Accepts degrees',
                        type:'angle'
                    }
                },
                returns:{
                    help:'The cosine of the angle',
                    type:'float'
                }

            },
            'func:tan':{run:function(params) {
                    return (Math.tan(piBy180 * parseFloat(evaluate(params))));
                },
                help:'Trignometric tangent function',
                shorthelp:'Trignometric tangent function',
                params:{
                    angle:{
                        help:'The angle to get tangent for. Accepts degrees',
                        type:'angle'
                    }
                },
                returns:{
                    help:'The tangent of the angle',
                    type:'float'
                }

            },
            'func:asin':{run:function(params) {
                    return (Math.asin(parseFloat(evaluate(params))* 180/Math.PI ));
                },
                help:'Trignometric arc sine function',
                shorthelp:'Trignometric arc sine function',
                params:{
                    sine:{
                        help:'The angle to get arc sine for. Accepts degrees',
                        type:'float'
                    }
                },

                returns:{
                    help:'The arc sine of the angle',
                    type:'angle'
                }

            },
            'func:acos':{run:function(params) {
                    return (Math.acos(parseFloat(evaluate(params))* 180/Math.PI ));
                },
                help:'Trignometric arc cosine function',
                shorthelp:'Trignometric arc cosine function',
                params:{
                    cosine:{
                        help:'The angle to get arc cosine for. Accepts degrees',
                        type:'float'
                    }
                },
                returns:{
                    help:'The arccosine of the angle',
                    type:'float'
                }

            },
            'func:atan':{run:function(params) {
                    return (Math.atan(parseFloat(evaluate(params))* 180/Math.PI ));
                },
                help:'Trignometric arctangent function',
                shorthelp:'Trignometric arctangent function',
                params:{
                    arctangent:{
                        help:'The angle to get arc tangent for. Accepts degrees',
                        type:'float'
                    }
                },
                returns:{
                    help:'The arctangent of the angle',
                    type:'angle'
                }

            },
            'func:pickfrom':{run:function(params) {
                    var thelist=lists['lists:'+params.shift()];
                    return thelist.data[thelist.index++%thelist.data.length];
                },
                help:'Picks an item from a predefined list. Wraps around after the last item',
                shorthelp:'Picks an item from a predefied list',
                params:{
                    name:{
                        help:'The list formerly defined using "setlist" command',
                        type:'list'
                    }
                },
                returns:{
                    help:'the next item in the list',
                    type:'any'
                }

            },
            'func:add':{run:function(params) {
                    return (parseFloat(evaluate(params)) + parseFloat(evaluate(params)));
                }
            },
            'func:sub':{run:function(params) {
                    return (parseFloat(evaluate(params)) - parseFloat(evaluate(params)));
                }
            },
            'func:mul':{run:function(params) {
                    return (parseFloat(evaluate(params)) * parseFloat(evaluate(params)));
                }
            },
            'func:div':{run:function(params) {
                    return (parseFloat(evaluate(params)) / parseFloat(evaluate(params)));
                }
            },
            'func:mod':{run:function(params) {
                    return (parseFloat(evaluate(params)) % parseFloat(evaluate(params)));
                }
            },
            'func:abs':{run:function(params) {
                    return (Math.abs(parseFloat(evaluate(params))));
                }
            },
            'func:rgb':{run:function(params) {
                    return ('rgb('+evaluate(params) + ',' +evaluate(params) + ','+evaluate(params) + ')');
                },
                help:'Returns a css representation of the color formed from red green and blue specified, mostly usefull with the "color" command. Usefull for generating the representation from values derived computationaly',
                shorthelp:'css representation of the color from red, green and blue values',
                params:{
                    red:{
                        help:'The red component of the color',
                        type:'integer',
                        parseropts:{min:0,max:255}
                    },
                    green:{
                        help:'The green component of the color',
                        type:'integer',
                        parseropts:{min:0,max:255}
                    },
                    blue:{
                        help:'The blue component of the color',
                        type:'integer',
                        parseropts:{min:0,max:255}
                    },
                },
                returns:{
                    help:'the css representation',
                    type:'color'
                }

            },
            'func:rgba':{run:function(params) {
                    return ('rgb('+evaluate(params) + ',' +evaluate(params) + ',' +evaluate(params) + ','+evaluate(params) + ')');
                },
                help:'Returns a css representation of the color formed from red, green, blue and alpha values, mostly usefull with the "color" command. Usefull for generating the representation from values derived computationaly',
                shorthelp:'css representation of the color from red, green, blue and alpha values',
                params:{
                    red:{
                        help:'The red component of the color',
                        type:'integer',
                        parseropts:{min:0,max:255}
                    },
                    green:{
                        help:'The green component of the color',
                        type:'integer',
                        parseropts:{min:0,max:255}
                    },
                    blue:{
                        help:'The blue component of the color',
                        type:'integer',
                        parseropts:{min:0,max:255}
                    },
                    alpha:{
                        help:'The alpha component of the color',
                        type:'float',
                        parseropts:{min:0,max:1}
                    }
                },
                returns:{
                    help:'the css representation',
                    type:'color'
                }
            },
            'func:hsl':{run:function(params) {
                    return ('rgb('+evaluate(params) + ',' +evaluate(params) + ','+evaluate(params) + ')');
                },
                help:'Returns a css representation of the color formed from hue, saturation and luminosity values, mostly usefull with the "color" command. Usefull for generating the representation from values derived computationaly',
                shorthelp:'css representation of the color from hue, saturation and luminosity values',
                params:{
                    hue:{
                        help:'The hue component of the color',
                        type:'integer',
                        parseropts:{min:0,max:255}
                    },
                    saturation:{
                        help:'The saturation component of the color',
                        type:'integer',
                        parseropts:{min:0,max:255}
                    },
                    luminosity:{
                        help:'The luminosity component of the color',
                        type:'integer',
                        parseropts:{min:0,max:255}
                    }
                },
                returns:{
                    help:'the css representation',
                    type:'color'
                }

            },
            'func:hsla':{run:function(params) {
                    return ('rgb('+evaluate(params) + ',' +evaluate(params) + ',' +evaluate(params) + ','+evaluate(params) + ')');
                },
                help:'Returns a css representation of the color formed from hue, saturation and luminosity values, mostly usefull with the "color" command. Usefull for generating the representation from values derived computationaly',
                shorthelp:'css representation of the color from hue, saturation and luminosity values',
                params:{
                    hue:{
                        help:'The hue component of the color',
                        type:'integer',
                        parseropts:{min:0,max:255}
                    },
                    saturation:{
                        help:'The saturation component of the color',
                        type:'integer',
                        parseropts:{min:0,max:255}
                    },
                    luminosity:{
                        help:'The luminosity component of the color',
                        type:'integer',
                        parseropts:{min:0,max:255}
                    },
                    alpha:{
                        help:'The alpha component of the color',
                        type:'float',
                        parseropts:{min:0,max:1}
                    },
                },
                returns:{
                    help:'the css representation',
                    type:'string'
                }


            },
            'func:rnd':{run:function(params) {
                    return (Math.random());
                },
                help:'returns a random number between 0 and 1',
                shorthelp:'returns a random number between 0 and 1',
                returns:{
                    help:'the random number',
                    type:'float'
                }
            },
            'func:ceil':{run:function(params) {
                    return (Math.ceil(parseFloat(evaluate(params))));
                },
                help:'returns the ceiling of the given float. (Integer next to the float, unless itself an integer)',
                shorthelp:'returns the ceiling of the given float',
                params:{
                    float:{
                        help:'a floating point number',
                        type:'float'
                    }
                },
                returns:{
                    help:'the ceil of the number',
                    type:'integer'
                }

            },
            'func:floor':{run:function(params) {
                    return (Math.floor(parseFloat(evaluate(params))));
                },
                help:'returns the floor of the given float. (Integer previous to the float, unless itself an integer)',
                shorthelp:'returns the floor of the given float',
                params:{
                    float:{
                        help:'a floating point number',
                        type:'float',
                    }
                },
                returns:{
                    help:'the floor of the number',
                    type:'integer'
                }

            },
            'func:round':{run:function(params) {
                    return (Math.round(parseFloat(evaluate(params))));
                },
                help:'returns the rounded integer of the given float. (Integer nearest to the float)',
                shorthelp:'returns the round integer of the given float',
                params:{
                    float:{
                        help:'a floating point number',
                        type:'float'
                    }
                },
                returns:{
                    help:'the floor of the number',
                    type:'integer'
                }
            },
            'func:curX':{run:function(params) {
                    return (pen.x);
                },
                help: 'returns the current x coordinate of the pen',
                shorthelp: 'returns the current x coordinate of the pen',
                params:{},
                returns:{
                    help:'the current x coordinate of the pen',
                    type: 'float',
                }
            },
            'func:curY':{run:function(params) {
                    return (pen.y);
                },
                help: 'returns the current y coordinate of the pen',
                shorthelp: 'returns the current y coordinate of the pen',
                params:{},
                returns:{
                    help:'the current y coordinate of the pen',
                    type: 'float',
                }

            },
            'func:curColor':{run:function(params) {
                    return (pen.y);
                },
                help: 'returns the current color of the pen',
                shorthelp: 'returns the current color of the pen',
                params:{},
                returns:{
                    help:'the current x coordinate of the pen',
                    type: 'color',
                }

            },
            'func:curWidth':{run:function(params) {
                    return (pen.width);
                },
                help: 'returns the current width of the pen',
                shorthelp: 'returns the current width of the pen',
                params:{},
                returns:{
                    help:'the current width of the pen',
                    type: 'float',
                }

            },
            'func:curAngle':{run:function(params) {
                    return (pen.angle);
                },
                help: 'returns the current angle of the pen',
                shorthelp: 'returns the current angle of the pen',
                params:{},
                returns:{
                    help:'the current angle of the pen',
                    type: 'float',
                }
            },
        };
        var commands={'pendown':{run: function(params){
                                        pen.down=true;
                                      },
                                'help':'Make the pen touch the paper. The commands "fwd" and "back" will henceforth make the items draw.',
                                'shorthelp':'Make the pen touch the paper.',
                                'params':{}
                                },
                      'penup':{run: function(params){
                                        pen.down=false;
                                      },
                                'help':'Make the pen not touch the paper. The commands "fwd" and "back" will henceforth only make the pen move.',
                                'shorthelp':'Make the pen not touch the paper.',
                                'params':{}
                                },
                      'angle':{run: function(params) {
                                        var angle=evaluate(params);
                                        pen.angle=getNum(angle);
                                        pen.angle%=360;
                                    },
                                'help':'Sets the angle in which to move the pen',
                                'shorthelp':'Sets the angle in which to move the pen',
                                'params':{
                                    'angle':{help: 'The angle in degrees ',type:'angle'},
                                 }
                           },
                      'width':{run: function(params) {
                                        pen.width=evaluate(params);
                                    },
                                'help':'Sets the linewidth of the pen',
                                'shorthelp':'Sets the linewidth of the pen',
                                'params':{
                                    'width':{help: 'width in pixels',type:'pixels'},
                                 }
                           },
                      'right':{run: function(params) {
                                    var angle=evaluate(params);
                                    pen.angle+=getNum(angle);
                                    pen.angle%=360;
                                },
                                'help':'Offsets the angle to the right in which to move the pen',
                                'shorthelp':'Offsets the angle to the right in which to move the pen',
                                'params':{
                                    'angle':{help: 'The angle in degrees ',type:'angle'}
                                 }

                       },
                       'left':{run: function(params) {
                                    var angle=evaluate(params);
                                    pen.angle-=getNum(angle);
                                    pen.angle%=360;
                                },
                                'help':'Offsets the angle to the left in which to move the pen',
                                'shorthelp':'Offsets the angle to the left in which to move the pen',
                                'params':{'angle': {help:'The angle in degrees',type:'angle'}}
                        },
                        'fwd':{run: function(params) {
                                   if (pen.down){
                                       var d = evaluate(params);
                                       cx.beginPath();
                                       cx.moveTo(getNum(pen.x), getNum(pen.y));
                                       cx.strokeStyle = pen.color;
                                       cx.lineWidth = pen.width;
                                       pen.x = getNum(pen.x) + getNum(Math.cos(pen.angle*piBy180) * d);
                                       pen.y = getNum(pen.y) + getNum(Math.sin(pen.angle*piBy180) * d);
                                       cx.lineTo(getNum(pen.x), getNum(pen.y));
                                       cx.closePath();
                                       cx.stroke();
                                   } else {
                                       var d = evaluate(params);
                                       pen.x = getNum(pen.x) + getNum(Math.cos(pen.angle*piBy180) * d);
                                       pen.y = getNum(pen.y) + getNum(Math.sin(pen.angle*piBy180) * d);
                                       cx.moveTo(pen.x, pen.y);
                                   }
                               },
                                'shorthelp':'Moves the pen forward by n pixels',
                                'help':'Moves the pen forward n pixels in the angle of the pen',
                                'params':{'distance':{help: 'The distance in pixel by which to move the pen from its current position',type:'pixels'}}
                        },
                        'back':{run: function(params){commands['fwd'].run([-evaluate(params)])},
                                'shorthelp':'Moves the pen backward by n pixels',
                                'help':'Moves the pen backward n pixels in the angle of the pen from its currnet position',
                                'params':{'distance': {help: 'The distance in pixel by which to move the pen from its current position',type:'pixels'}}
                               },
                        'goto':{run: function(params) {
                                     pen.x = getNum(evaluate(params));
                                     pen.y = getNum(evaluate(params));
                                     cx.moveTo(pen.x,pen.y);
                                 },
                                'shorthelp':'Moves the pen to the given posisiton without drawing anything',
                                'help':'Moves the pen forward n pixels in the angle of the pen',
                                'params':{'distanceX': {help:'X part of the co ordinate',type:'pixels'},
                                          'distanceY': {help:'Y part of the co ordinate',type:'pixels'}
                                         }

                        },
                        'info':{run: function(params) {
                                     logIt('<b>Pen:</b> '+JSON.stringify(pen));
                                     logIt('<b>Variables:</b>'+JSON.stringify(vars));
                                     logIt('<b>lists:</b>'+JSON.stringify(lists));
                                     saveLast=false;
                                },
                                'shorthelp':'Prints different properties of the pen and environment',
                                'help':'Prints different properties of the pen such as angle, current position, color. los lists the variables and lists',
                                'params':{}

                        },
                        'color':{run: function(params) {
                                    pen.color = evaluate(params);
                                },
                                'help':'Sets the ink color of the pen',
                                'shorthelp':'Sets the ink color of the pen',
                                'params':{ 'color': {help: 'the color name to set the color of the ink to. It can be any color that is accepted by css as color. Generally includes many common colors.',type:'color'}}

                        },
                        'clear':{run: function(params) {
                                cx.fillStyle='white';
                                cx.fillRect(0,0,c.width,c.height);
                            },
                                'help':'clears the screen',
                                'shorthelp':'clears the screen',
                                'params':{}

                        },
                        'rpt': {run: function(p) {
                                    var extracted=extractblock_multi(p,'rpt','endrpt');
                                    
                                    var times = evaluate(extracted); 
                                    for (var i = 0; i < times; i++){
                                        execit(extracted.slice());
                                    }
                                },
                                'help':'Repeat the set of commands following, bounded by endrpt',
                                'shorthelp':'Repeat the set of commands following, bounded by endrpt',
                                'params':{
                                    times:{
                                        help:'The number of times to repeat the steps',
                                        type:'integer'
                                    },
                                    commands:{
                                        help:'the set of instructions to repeat',
                                        type:'block',
                                        parseropts:{
                                            blockstart:'rpt',
                                           blockend:'endrpt'
                                        }
                                    }
                                  }

                        },
                        'save':{run: function(params){
                                        var currentlist=JSON.parse(localStorage.getItem('logoish_saved'));
                                        if (currentlist == null) currentlist=[];
                                        var name=params.shift();
                                        if (currentlist.indexOf(name) == -1){
                                            localStorage.setItem('logoish_saved_' + name,last_run_command);
                                            currentlist.push(name);
                                            localStorage.setItem('logoish_saved',JSON.stringify(currentlist));
                                            logIt('saved');
                                        } else {
                                            logIt('ERROR: name already taken');
                                        }
                                        saveLast=false;
                                    },
                                
                                'help':'Saves the last command to given slot',
                                'shorthelp':'Saves the last command to the given slot',
                                'params':{'slotname':{help: 'The alphanumeric name of the slot to save. No overwriting allowed.',type:'stringasis' }}

                               },
                        'show':{run: function(params){
                                        var currentlist=JSON.parse(localStorage.getItem('logoish_saved'));
                                        if (currentlist == null) currentlist=[];
                                        var name=params.shift();
                                        if (currentlist.indexOf(name) != -1){
                                            i.value=(localStorage.getItem('logoish_saved_' + name));
                                        } else {
                                            logIt('ERROR: No such item saved');
                                        }
                                        saveLast=false;
                                      },
                                 dontclear:true,
                                'shorthelp':'Show a saved commmand',
                                'help':'Retrieve and populate the command prompt with a saved command, ready to be executed',
                                'params':{'slotname':{help: 'The name of the slot to show the command from',type:'stringasis' }}

                                },
                        'last':{run: function(params){
                                      i.value=last_run_command;
                                      saveLast=false;
                                      },
                                 dontclear:true,
                                },
                        'delete': {run: function(params){
                                        var currentlist=JSON.parse(localStorage.getItem('logoish_saved'));
                                        if (currentlist == null) currentlist=[];
                                        var name=params.shift();
                                        if (currentlist.indexOf(name) != -1){
                                            localStorage.removeItem('logoish_saved_' + name);
                                        } else {
                                            logIt('ERROR: No such item saved');
                                        }
                                        saveLast=false;
                                   },
                                'shorthelp':'Deletes the command from the given slot',
                                'help':'Deletes the command from the given slot',
                                'params':{'slotname':{help: 'The alphanumeric name of the slot to delete',type:'stringasis' }}

                                },
                        'saved': {run: function(params){
                                        logIt(JSON.parse(localStorage.getItem('logoish_saved')));
                                        saveLast=false;
                                      },
                                'shorthelp':'List the name of saved command slots',
                                'help':'Lists the name of saved command slots',
                                'params':{}
                                },
                        'set':{run: function(params){
                                        var name = params.shift();
                                        if (functions.hasOwnProperty('func:'+name)) logIt(name + ' is a function. ERROR Cannot use it as a variable');
                                        vars['vars:'+ name]=evaluate(params);
                                    },
                                'help':'sets the value of a variable to the given value',
                                'shorthelp':'sets the value of a variable',
                                'params':{
                                            'varname':{help: 'The alphanumeric name of the variable to set. Overwriting allowed. Note: cannot use function names as variables',type:'varname' },
                                            'value':{help: 'The value to set.',type:'any' }
                                         }
                               },
                        'incr':{run: function(params){
                                        var name = params.shift();
                                        var val=evaluate(params);
                                        var varname='vars:'+name;

                                        if (functions.hasOwnProperty('func:'+name)) logIt(name + ' is a function. ERROR Cannot use it as a variable');
                                        vars[varname]= parseFloat(vars[varname]) + parseFloat(val);
                                    },
                                'help':'increases the value of a variable by given value',
                                'shorthelp':'increases the value of a variable by given value',
                                'params':{
                                            'varname':{help: 'The alphanumeric name of the variable to increase. Note: cannot use function names as variables',type:'varname' },
                                            'value':{help: 'The value to increase by.',type:'any'}
                                         }
                               },
                        'decr':{run: function(params){
                                        var name = params.shift();
                                        var val=evaluate(params);
                                        var varname='vars:'+name;

                                        if (functions.hasOwnProperty('func:'+name)) logIt(name + ' is a function. ERROR Cannot use it as a variable');
                                        vars[varname]= parseFloat(vars[varname]) - parseFloat(val);
                                    },
                                'help':'decreases the value of a variable by given value',
                                'shorthelp':'decreases the value of a variable by given value',
                                'params':{
                                            'varname':{help: 'The alphanumeric name of the variable to decrease. Note: cannot use function names as variables', type:'varname'},
                                            'value':{help: 'The value to decrease by.', type:'any' }
                                         }
                               },
                        'setlist':{run: function(params){
                                        var name = params.shift();
                                        if (functions.hasOwnProperty('func:'+name)) logIt(name + ' is a function. ERROR Cannot use it as a variable');
                                        if (vars.hasOwnProperty('vars:'+name)) logIt(name + ' is a function. ERROR Cannot use it as a variable');
                                        lists['lists:'+ name]={data:extractblock_single(params,'setlist','endlist'), index:0};
                                    },
                                'help':'Creates a list of items. Use the pickfromlist function.',
                                'shorthelp':'Creates a list of items',
                                'params':{
                                            'listname':{
                                                help: 'The alphanumeric name of the list to set. Overwriting allowed. Note: cannot use function names as variables',
                                                type:'varname'
                                             },
                                            'list':{
                                                help: 'list of items followed by endlist',
                                                type:'block',
                                                parseropts:{
                                                    blockstart:'setlist',
                                                    blockend:'endlist'
                                                } 
                                             }
                                         }
                               },
                        'anim':{run: function(params){
                                        var endsat = params.indexOf('endanim');
                                        var animating=false;
                                        var animdone=false;
                                        var counter;
                                        var curanim=[];
                                        var times,delay;
                                        if (endsat == -1) logIt('ERROR: animation does not end!'); 
                                        var extracted = params.slice(0,endsat).split('nextanim'); //also prevent the params from geting "shift"ed off for the next iteration 

                                        var anim_hungry=true;
                                        var animslice=function (){ 
                                            if (anim_hungry){
                                                curanim=extracted.shift();
                                                counter=0;
                                                logIt('Checking for animations ..');
                                                if (curanim==undefined){
                                                    animdone=true;
                                                    logIt('animations ended');
                                                    return;
                                                }
                                                logIt('got animation, animating ..');
                                                
                                                times = evaluate(curanim);
                                                delay = evaluate(curanim);

                                                var preanimend=curanim.indexOf('endpreanim');
                                                if (preanimend!=-1){
                                                    var preanim=curanim.slice(0,preanimend);
                                                    execit(preanim);
                                                    curanim.splice(0,preanimend+1);
                                                }

                                                anim_hungry=false;
                                            }

                                            if (counter < times){
                                                if (!animating){
                                                    var animating=true;
                                                    execit(curanim.slice());
                                                    counter++;
                                                    animating=false;
                                                }
                                            } else {
                                                    anim_hungry=true;
                                            }
                                            setTimeout(animslice,delay); 

                                        };
                                        animslice();
                                        params.splice(0,endsat+1);
                                    },
                                'help':'Animates the commands till "endanim" optionally seperated by "nextanim"',
                                'shorthelp':'Animates the commands till "endanim". You cannot currently have more than one animation block. But you can do multiple animations in the same block. Just use "nextanim" followed by times and delay parameter to mark the seperation. To get a clearer idea, look at the examples',
                                'params':{
                                            'times':{
                                                help: 'the number of times to animate',
                                                type:'integer'
                                             },
                                            'delay':{
                                                help: 'the delay between frames in milliseconds',
                                                type:'milliseconds'
                                             },
                                            'commandblock':{
                                                help: 'the set of instructions to repeat for each frame', 
                                                type:'block',
                                                parseropts:{
                                                    blockstart:'anim',
                                                    blockend:'endanim'
                                                }
                                             }
                                         }
                               },
                        'resetlist':{run: function(params){
                                        var name = params.shift();
                                        if (vars.hasOwnProperty('vars:'+name)) logIt(name + ' is not a list Cannot reset');
                                        if (functions.hasOwnProperty('func:'+name)) logIt(name + ' is not a list Cannot reset');
                                        if (!lists.hasOwnProperty('lists:'+name)) logIt(name + ' is not a list. Cannot reset');
                                        lists['lists:'+ name].index=0;
                                    },
                                'help':'Resets the index of the list back to the first item in the list',
                                'shorthelp':'Resets the index of the list back to the first item in the list',
                                'params':{
                                            'varname':{help: 'The alphanumeric name of the list whose index is to be reset.',type:'varname'},
                                         }
                               },
                        'evaldisp':{run: function(params){
                                        logIt(evaluate(params));
                                    },
                                    shorthelp: 'evaluate and display the result of the function call or variable that follows',
                                    help: 'evaluate and display the result of the function call or variable that follows',
                                    params:{
                                        'expression':{
                                            help:'can be any kind of expression that results in a value',
                                            type:'any'
                                         }
                                    }
                               },
                        'listexamples':{run: function(params){
                                    logIt(Object.keys(examples).map(function(x){return x.split(':')[1]}));
                                },
                                shorthelp:'Show a list of examples.',
                                help:'Show a list of examples. Use the showexample command to use individual examples',
                                params:{},
                         },
                        'showexample':{run: function(params){
                                        var name='example:'+params.shift();
                                        if (Object.keys(examples).indexOf(name) != -1){
                                            i.value=examples[name];
                                        } else {
                                            logIt('ERROR: No such example');
                                        }
                                        saveLast=false;
                                      },
                                 dontclear:true,
                                'shorthelp':'Show an inbuilt example',
                                'help':'Retrieve and populate the command prompt with a saved example, ready to be executed',
                                'params':{'slotname':{help: 'The name of the example. to show',type:'stringasis'}}

                                
                        },
                        'comment':{run: function(params){
                                            extractblock_single(params,'comment','endcomment');
                                  }, 
                                  help: 'anything between "comment" and "endcomment" will be ignored',
                                  shorthelp:'anything between "comment" and "endcomment will" be ignored. But it has to be entered as a seperate command, and cannot come in between parameters of commands' ,
                                  params:{
                                        comment: {help: 'the comment' , type:'block',parseropts:{blockstart:'comment',blockend:'endcomment'}}
                                    }
                         },
                        'function':{run: function(params){
                                    user_functions['func:'+evaluate(params)].run();
                                },
                                help:'register user defined functions',
                                shorthelp:'register user defined functions',
                                params:{
                                        name: {help: 'the name of the function',type:'stringasis'},
                                        'params': {
                                            help:'the list of parameters must be defined between "params" and "endparams"',
                                            type:'block',
                                            parseropts:{
                                                blockstart:'params',
                                                blockend: 'endparams',
                                                begun:true
                                            }
                                        }

                                }
                        },

                        'help': {
                            run:function(params){
                                function hasShortHelp(topic){
                                    return commands.hasOwnProperty(topic) && (commands[topic].shorthelp != undefined);
                                }
                                function hasHelp(topic){
                                    return commands.hasOwnProperty(topic) && (commands[topic].help != undefined);
                                }
                                function getShortHelp(topic){
                                    if (hasShortHelp(topic)){
                                        return commands[topic].shorthelp;
                                    } else {
                                        return '';
                                    }
                                }
                                function getHelp(topic) {
                                    var helptext='';
                                    if (hasHelp(topic)) {
                                        helptext=commands[topic].help;
                                        if (Object.keys(commands[topic].params).length > 0) {
                                            helptext+='<h3>Parameters</h3>';
                                            for (var i in commands[topic].params) {
                                                helptext+='<b>'+i+'</b>: ' + commands[topic].params[i].help + '<br>' ;
                                            }
                                        }
                                       return helptext;
                                    } else {
                                        return 'No Such Topic';
                                    }

                                }
                                topic = params.shift();
                                var helptext='';
                                if (topic == 'all' || topic == undefined) {
                                    for (command in commands){
                                        if (hasShortHelp(command)){
                                            helptext+="<br><span style='font-weight:bold'>"+command+"</span>:";
                                            helptext+=getShortHelp(command);
                                        }
                                    }
                                    helptext+='<h4>Functions</h4>'+Object.keys(functions).map(function(x) {return x.split(':')[1]}).join(',');
                                    helptext+="<br><h4>Examples</h4> use <code>listexamples</code> and <code>showexample examplename</code> to go through inbuilt examples. They should give you a fair idea of how to write logoish programs. \nRemember this is pre-alpha stuff. Syntax subject to change.\nAnd hey! Don't forget to 'pendown' first!";
                                } else {
                                    helptext=getHelp(topic);
                                }
                                logIt(helptext);
                                saveLast=false;
                            },
                            help:'shows this help',
                            shorthelp:'shows this help',
                            params: { 
                                'topic':{
                                    help:'the topic',
                                    type:'stringasis'
                                 }
                            } 
                        }
        };

        function execit(params){
            while (params.length > 0){
                var command = params.shift();
                try{ 
                        if (commands.hasOwnProperty(command)){
                            commands[command].run(params);
                            if (!commands[command].dontclear) i.value='';
                        } else {
                            logIt('Uh oh.. dont know how to do ' + htmlescape(command) + ' If you want to check the contents of a variable or return value of a function, use the "evaldisp" command.');
                            //params=[];
                        }
                } catch(e){
                    logIt(escape(e));
                }
            }
            return false;
        }
    </script>
    <script src=examples.js></script>

</body>
</html>
